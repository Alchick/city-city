#coding: utf-8
import os
from flask import render_template, request, flash, url_for, redirect
from app import app, login_manager
from forms import ArticleForms
from check_functions import save_request_data, get_data_from_db, registered_user, insert_comment
from flask.ext.login import login_user, logout_user, current_user, login_required
from datetime import datetime

@login_manager.user_loader
def load_user(user_id):
    return db.session.query(models.culture_admins).filter(models.culture_admins.id == user_id).first()


#LOGIN VIEWS
@app.route('/login', methods = ['GET', 'POST'])
def login():
    if request.method == 'GET':
        return render_template('login.html')
    username = request.form.get('username')
    password = request.form.get('password')
    remember_me = False
    if request.form.get('remember_me'):
        remember_me = True
    if registered_user(username) is None:
        flash('Username is invalid', 'error')
        return redirect(url_for('login'))
    if not registered_user(username).check_password(password):
        flash('Invalid password', error)
        return redirect(url_for('login'))
    login_user(registered_user(username), remember = remember_me)
    flash('Logged is successfully')
    return redirect(request.args.get('next') or url_for('index'))





#PAGES VIEWS
@app.route('/')
@app.route('/index.html')
def index():
    print url_for('static', filename='css/stylemain.css')
    return render_template("index.html")

@app.route('/about.html')
def about():
    return render_template("about.html")


@app.route('/read.html')
def read():
    records = get_data_from_db()
    return render_template("read.html",
                           records = records)

@app.route('/get_file.html', methods = ['GET', 'POST'])
def get_file():
    comments = {}
    if request.args:
        filename = request.args.get('filename') #could it be empty?
        article_name = request.args.get('article_name') #could it be empty?
        author_name = request.args.get('author_name') #could it be empty?
        date = request.args.get('date') #could it be empty?
        id = request.args.get('id')
        passi = request.args.get('passi') #could it be empty?
        if passi:
            comments = {'user1':'comment1',\
                        'user2':'comment2',\
                        'user3':'comment3',\
                        'user4':'comment4'}
        return render_template("get_file.html",\
                               filename = filename,\
                               article_name = article_name,\
                               author_name = author_name,\
                               date = date,\
                               passi = passi,\
                               comments = comments,\
                               id = id)
    else: return redirect('read.html')

@app.route('/contacts.html')
def contact():
    return render_template("contacts.html")

@app.route('/create.html', methods = ['GET', 'POST'])
def create():
    form = ArticleForms()
    if request.method == 'POST' and form.validate_on_submit():
        flash(save_request_data(request))
        return render_template('create.html',\
                                form=form)
    return render_template("create.html",\
                           form=form)

@app.route('/admin.html', methods = ['GET', 'POST'])
@login_required
def admin():
    records = get_data_from_db()
    return render_template('admin.html',\
                            records = records)

@app.route('/set_comment.html', methods = ['POST'])
def set_comment():
    result = request.form.get('value')
    print result.split('&') 
    return 'Normik'


#ERRORS
@app.errorhandler(413)
def EntityTooLarge(error):
    return render_template("error.html", error = 413), 413

@app.errorhandler(404)
def page_not_found(error):
    return render_template("error.html", error = 404), 404


